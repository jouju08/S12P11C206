from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import BaseOutputParser


class Parser(BaseOutputParser):
    def parse(self, output):
        # Split the output into lines
        lines = output.strip().split("\n")
        # Filter out empty lines and extract the content after the numbering
        sentences = [line.split(". ", 1)[1] for line in lines if ". " in line]
        return sentences


prompt = ChatPromptTemplate.from_messages([
    ("system",

     """
당신은 동화책 각색 작가입니다. 아래 제공된 각색된 동화 내용을 참고하여, 해당 내용을 창의적으로 계속 이어나가십시오.

# Requirements

- 필수문장을 반드시 포함해야 합니다.
- 이야기는 4개의 문단으로 이루어져야 합니다.
- 각 문단은 200글자 내외로 작성되어야 합니다.

# Steps

1. 기존 각색 내용을 기반으로 스토리를 확장하십시오.
2. 필수문장을 각 문단에 자연스럽게 통합하십시오.
3. 문단을 구분하여 각 200글자 내외로 서술하십시오.

# Output Format

이야기는 4개의 문단 형식으로, 각 문단은 약 200글자로 구성되도록 작성해 주십시오.

# Notes

- 필수문장을 매우 자연스럽게 통합하여 이야기를 방해하지 않도록 구성하십시오.
- 각 문단을 분리하여 표시하시고, 내용의 흐름이 논리적이고 매끄럽게 이어지도록 하십시오.
"""),
    ("human", """
제목: 잭과 콩나무
필수문장:
['잭은 하늘까지 닿은 거대한 콩나무를 타고 올라갔습니다.', '그는 구름 위에 숨겨진 거인의 성을 발견했습니다.',
    '용기를 내어, 아침 노래를 부르는 황금 하프를 훔쳤습니다.','거인이 쫓아오는 동안, 콩나무가 흔들리기 시작했습니다.']
도입:
잭은 호기심 많은 소년으로 홀어머니와 작은 오두막에 살고 있었습니다. 어느 날, 그는 소를 마법의 콩 몇 알과 바꾸고 그것을 집 앞에 심었습니다.
"""),

    ("ai", """
1.
다음 날 아침, 잭은 눈을 뜨고 깜짝 놀랐습니다. 집 앞에 심었던 콩에서 거대한 나무가 하늘 끝까지 솟아 있었습니다. 그는 마법의 콩나무를 타고 올라가 보기로 결심했습니다. "이 나무 끝에 뭐가 있을까?" 잭은 두근거리는 마음을 안고, 잎사귀와 덩굴을 붙잡으며 끝없이 올라갔습니다. 드디어 구름 위에 도착한 잭은 믿을 수 없는 광경을 마주했습니다. 잭은 하늘까지 닿은 거대한 콩나무를 타고 올라갔습니다. 그곳에는 황금빛으로 빛나는 거대한 성이 구름 속에 숨겨져 있었습니다.
2.
성 안으로 들어간 잭은 웅장한 홀과 반짝이는 보물들 사이를 조심스럽게 걸었습니다. 그곳에는 거인이 있었지만, 깊은 잠에 빠져 있는 것처럼 보였습니다. 잭은 성을 둘러보던 중 황금 하프가 홀로 노래를 부르는 것을 발견했습니다. "이 하프를 가져가면 우리 집도 다시 풍요로워질 거야!" 잭은 용기를 내어, 아침 노래를 부르는 황금 하프를 훔쳤습니다. 하지만 하프가 소리를 멈추지 않아 거인은 잠에서 깨어났고, 커다란 눈으로 잭을 노려보며 으르렁댔습니다.
3.
거인은 잭을 잡으려고 성을 뒤쫓기 시작했습니다. 잭은 하프를 꼭 안고 콩나무로 달려갔습니다. 거인은 거대한 발소리로 땅을 울리며 잭을 따라왔습니다. 마침내 콩나무에 도착한 잭은 서둘러 아래로 내려가기 시작했습니다. 하지만 거인도 잭을 뒤쫓으며 콩나무를 흔들었습니다. 거인이 쫓아오는 동안, 콩나무가 흔들리기 시작했습니다. 잭은 두려움에 떨며 필사적으로 나무를 내려갔지만, 거인의 손길이 점점 가까워지고 있었습니다.
4.
땅에 도착한 잭은 재빨리 도끼를 집어 들고 콩나무를 찍기 시작했습니다. "어서 무너져라!" 그는 온 힘을 다해 나무를 찍었습니다. 콩나무는 점점 기울더니 마침내 큰 굉음과 함께 쓰러졌습니다. 거인은 균형을 잃고 구름 속으로 사라졌습니다. 황금 하프 덕분에 잭과 그의 어머니는 다시 행복하고 풍요롭게 살게 되었습니다. 잭은 더 이상 마법의 모험을 두려워하지 않았습니다. "용기와 지혜가 있다면, 무엇이든 할 수 있어!" 그는 스스로를 다짐하며 미소를 지었습니다.
"""),
    ("human", """
제목: 성냥팔이 소녀
필수문장:
['성냥팔이 소녀는 편지지를 피워 따뜻함을 느꼈습니다.', '성냥팔이 소녀는 물방울을 보며 행복한 꿈을 꾸었습니다.',
    '성냥팔이 소녀는 감자을 향해 손을 뻗었습니다.', '사람들은 성냥팔이 소녀의 토끼를 발견하지 못했습니다.']
도입:
옛날 어느 겨울밤, 거리에 작은 소녀가 서 있었습니다. 그녀는 성냥을 팔며 하루를 버티는 성냥팔이 소녀였습니다. 그러나 그날은 유난히 추운 날이었고, 길가는 사람들은 누구도 그녀에게 관심을 기울이지 않았습니다.
"""),
    ("ai",
     """
1.
성냥팔이 소녀는 추위 속에서 떨며 앉아 있었습니다. 손끝이 얼어붙을 것 같았지만, 아무도 성냥을 사 주지 않았습니다. 그녀는 얼어붙은 손으로 성냥을 한 개 꺼내 불을 붙였습니다. 성냥불이 타오르자 마치 작은 난로 앞에 앉아 있는 듯한 따뜻함이 느껴졌습니다. "조금만 더 따뜻했으면 좋겠어." 성냥팔이 소녀는 편지지를 피워 따뜻함을 느꼈습니다. 하지만 불은 금세 꺼지고 다시 차가운 현실로 돌아왔습니다. 소녀는 떨리는 손으로 더 깊이 외투를 감싸며 고개를 숙였습니다.
2.
눈송이가 춤추듯 떨어지는 가운데, 소녀는 문득 반짝이는 물방울을 발견했습니다. 그 물방울은 마치 별처럼 빛났고, 그녀의 상상력을 자극했습니다. 소녀는 물방울을 보며 행복한 꿈을 꾸었습니다. 그녀는 눈이 부신 햇살 속에서 푸른 들판을 뛰어다니고, 따뜻한 모닥불 옆에서 노래를 부르는 자신을 떠올렸습니다. 꿈속에서는 더 이상 추위도 굶주림도 없었으며, 모든 것이 따뜻하고 평화로웠습니다. 그러나 꿈은 금세 사라지고, 소녀는 다시 얼어붙은 현실로 돌아왔습니다.
3.
그녀는 배고픔을 잊으려 또 한 개의 성냥을 켰습니다. 이번에는 따뜻한 감자 요리가 눈앞에 나타났습니다. 금빛으로 익어가는 감자 냄새가 그녀의 코끝을 간지럽혔습니다. "저것만 있다면 정말 행복할 텐데…" 소녀는 감자를 향해 손을 뻗었습니다. 그러나 손이 닿기도 전에 환상은 사라지고, 성냥불은 꺼졌습니다. 소녀는 한숨을 쉬며 고개를 떨구었지만, 마음 한구석에는 어쩐지 따뜻한 희망이 남아 있었습니다. "다음엔 더 큰 불을 붙일 수 있을 거야," 그녀는 속으로 다짐했습니다.
4.
성냥을 켜는 동안 소녀는 작은 토끼가 나타나는 꿈을 꾸었습니다. 토끼는 그녀 곁에 앉아 다정하게 그녀를 바라보았습니다. 소녀는 그 토끼를 품에 안으며 웃었지만, 현실 속 사람들은 성냥팔이 소녀의 토끼를 발견하지 못했습니다. 그녀는 차가운 거리 한복판에서 조용히 마지막 꿈을 꾸며 눈을 감았습니다. 그 밤이 지나고, 하얀 눈이 거리를 덮었을 때, 사람들은 그녀를 발견했습니다. 소녀는 평화로운 미소를 짓고 있었고, 그녀의 곁에는 작은 물방울과 희미한 성냥불의 흔적만 남아 있었습니다.
"""),
    ("human", """
제목: 아기돼지 삼형제
필수문장:
['첫번째 아기돼지는 구름으로 만든 집을 지었습니다.', '두번째 아기돼지는 깃털으로 만든 집을 지었습니다.',
    '세번째 아기돼지는 초콜릿으로 만든 집을 지었습니다.', '늑대는 아기돼지의 집을 망치로 무너뜨렸습니다.']
도입:
옛날 옛적에 아기돼지 삼형제가 살고 있었습니다. 이들은 각자 자신만의 집을 짓기로 결정했어요. 늑대는 첫째 돼지의 집에 와서 말했어요. "문을 열어라!"
     """),
    ("ai",
     """
1.
"구름은 가볍고 부드러우니 금방 집을 지을 수 있을 거야!" 그는 솜사탕 같은 구름을 모아 집을 완성했습니다. 하지만 늑대가 찾아와 "문을 열어라!"라고 외쳤을 때, 첫째 돼지는 두려움에 떨었습니다. 늑대가 숨을 크게 들이마시고 불어버리자, 구름으로 만든 집은 순식간에 사라져 버렸습니다. 첫째 돼지는 형제들에게 달려가며 도움을 청했습니다. "형들, 늑대가 내 집을 날려버렸어!"
2.
"깃털은 따뜻하고 포근하니까 안전할 거야!" 그는 새들의 깃털을 모아 아늑한 집을 만들었습니다. 그러나 늑대가 다시 찾아와 "문을 열어라!"라고 외쳤습니다. 두번째 돼지는 겁에 질렸지만, 깃털 집이 버텨주길 바랐습니다. 하지만 늑대가 또다시 강하게 불을 내뿜자, 깃털로 만든 집은 허공으로 흩어졌습니다. 두번째 돼지도 형제들에게 달려가며 외쳤습니다. "늑대가 내 집도 날려버렸어!"
3.
"초콜릿은 단단하고 맛있으니까 늑대도 쉽게 부수지 못할 거야!" 그는 달콤한 초콜릿 벽돌로 튼튼한 집을 지었습니다. 늑대가 찾아와 "문을 열어라!"라고 외쳤지만, 세번째 돼지는 자신만만했습니다. 그러나 늑대는 이번엔 숨을 불지 않고, 아기돼지의 집을 망치로 무너뜨렸습니다. 초콜릿 조각들이 사방으로 흩어졌고, 세번째 돼지도 형제들과 함께 도망쳐야 했습니다. "우린 이제 어떻게 해야 하지?"
4.
"이제 어떻게 해야 늑대에게서 안전할 수 있을까?" 그들은 서로의 실패를 교훈 삼아, 더 튼튼한 집을 짓기로 결심했습니다. 이번에는 벽돌과 시멘트를 사용해 단단한 집을 지었습니다. 늑대가 다시 찾아와 "문을 열어라!"라고 외쳤지만, 삼형제는 두려워하지 않았습니다. 늑대는 숨을 불어보기도 하고 망치를 휘둘러보기도 했지만, 집은 끄떡없었습니다. 결국 늑대는 포기하고 떠났고, 삼형제는 안전하게 행복하게 살 수 있었습니다. "함께라면 무엇이든 이겨낼 수 있어!"
 """),
    ("human", """
제목: {title}
필수문장:
{sentences}
도입:
{introduction}
"""),
])
